<script>
// ================================
// FIREBASE CONFIGURATION & INITIALIZATION
// ================================
const firebaseConfig = {
    apiKey: "AIzaSyD01uGyvyD9vyXa6SFAqxqEdEFuedc-b5M",
    authDomain: "e-commerce-f2233.firebaseapp.com",
    projectId: "e-commerce-f2233",
    storageBucket: "e-commerce-f2233.firebasestorage.app",
    messagingSenderId: "363586978941",
    appId: "1:363586978941:web:35b3b34237bca75b405d14"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Initialize Google provider
const googleProvider = new firebase.auth.GoogleAuthProvider();
googleProvider.addScope('email');
googleProvider.addScope('profile');

// ================================
// GLOBAL VARIABLES
// ================================
let cart = [];
let products = [];
let currentUser = null;
let isSignUpMode = false;
let currentCategory = 'all';
let currentPhotoIndex = 0;
let isPointerDown = false;
let startX = 0;
let currentX = 0;
let startTime = 0;
let currentProductId = null;

// ================================
// INITIALIZATION & EVENT LISTENERS
// ================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    console.log('Firebase available:', typeof firebase !== 'undefined');
    console.log('Firebase Auth available:', typeof firebase !== 'undefined' && !!firebase.auth);
    console.log('Auth instance:', auth);
    
    loadProductsFromFirebase();
    updateCartCount();
    
    // Add category change listener
    setTimeout(() => {
        const categorySelect = document.getElementById('dashboardProductCategory');
        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                const sizeRow = document.getElementById('clothingSizeRow');
                if (sizeRow) {
                    if (this.value === 'clothing') {
                        sizeRow.style.display = 'block';
                    } else {
                        sizeRow.style.display = 'none';
                    }
                }
            });
        }
    }, 1000);
});

// Firebase Auth State Observer
auth.onAuthStateChanged((user) => {
    currentUser = user;
    updateAuthUI();
    if (user) {
        console.log('User is signed in:', user);
    } else {
        console.log('User is signed out');
    }
});

// Window click event handler for modals
window.onclick = function(event) {
    const modal = document.getElementById('loginModal');
    const sellerModal = document.getElementById('sellerModal');
    const sellerDashboard = document.getElementById('sellerDashboard');
    const forgotModal = document.getElementById('forgotPasswordModal');
    const editModal = document.getElementById('editProductModal');
    
    if (event.target === modal) {
        closeLogin();
    }
    
    if (event.target === sellerModal) {
        closeSellerSignup();
    }
    
    if (event.target === sellerDashboard) {
        closeSellerDashboard();
    }
    
    if (event.target === forgotModal) {
        closeForgotPassword();
    }
    
    if (event.target === editModal) {
        closeEditProduct();
    }
    
    // Handle other modals
    if (event.target.classList.contains('modal') && 
        event.target !== modal && 
        event.target !== sellerModal && 
        event.target !== sellerDashboard && 
        event.target !== forgotModal &&
        event.target !== editModal) {
        event.target.style.display = 'none';
    }
};

// Document click event handler for sidebar
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.querySelector('.menu-toggle');
    
    if (sidebar && menuToggle && !sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
        sidebar.classList.remove('open');
    }
});

// ================================
// AUTHENTICATION FUNCTIONS
// ================================
function signInWithGoogle() {
    console.log('Google sign-in button clicked');
    
    // Check if Firebase Auth is loaded
    if (typeof firebase === 'undefined' || !firebase.auth) {
        console.error('Firebase Auth not loaded');
        alert('Authentication system not ready. Please refresh the page.');
        return;
    }
    
    console.log('Attempting Google sign-in...');
    
    auth.signInWithPopup(googleProvider)
        .then((result) => {
            currentUser = result.user;
            console.log('Google sign-in successful:', currentUser);
            updateAuthUI();
            closeLogin();
            alert(`Welcome ${currentUser.displayName || currentUser.email}!`);
        })
        .catch((error) => {
            console.error('Google sign-in error:', error);
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
            
            let errorMessage = 'Error signing in with Google: ';
            switch(error.code) {
                case 'auth/popup-closed-by-user':
                    errorMessage += 'Sign-in cancelled.';
                    break;
                case 'auth/popup-blocked':
                    errorMessage += 'Pop-up blocked. Please allow pop-ups.';
                    break;
                case 'auth/unauthorized-domain':
                    errorMessage += 'Domain not authorized. Contact support.';
                    break;
                default:
                    errorMessage += error.message;
            }
            alert(errorMessage);
        });
}

function handleEmailAuth(event) {
    event.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    if (isSignUpMode) {
        // Sign Up
        auth.createUserWithEmailAndPassword(email, password)
            .then((result) => {
                currentUser = result.user;
                console.log('Sign up successful:', currentUser);
                updateAuthUI();
                closeLogin();
                alert('Account created successfully!');
            })
            .catch((error) => {
                console.error('Sign up error:', error);
                alert('Error creating account: ' + error.message);
            });
    } else {
        // Sign In
        auth.signInWithEmailAndPassword(email, password)
            .then((result) => {
                currentUser = result.user;
                console.log('Sign in successful:', currentUser);
                updateAuthUI();
                closeLogin();
            })
            .catch((error) => {
                console.error('Sign in error:', error);
                alert('Error signing in: ' + error.message);
            });
    }
}

function signOut() {
    auth.signOut().then(() => {
        currentUser = null;
        updateAuthUI();
        closeLogin();
        alert('You have been signed out successfully.');
        console.log('User signed out');
    }).catch((error) => {
        console.error('Sign out error:', error);
        alert('Error signing out. Please try again.');
    });
}

function toggleAuthMode() {
    isSignUpMode = !isSignUpMode;
    updateAuthModalUI();
}

function updateAuthModalUI() {
    const modalTitle = document.getElementById('modalTitle');
    const submitBtn = document.getElementById('authSubmitBtn');
    const switchText = document.getElementById('switchText');
    const switchLink = document.getElementById('switchLink');
    
    if (isSignUpMode) {
        modalTitle.textContent = 'Sign Up';
        submitBtn.textContent = 'Sign Up';
        switchText.textContent = 'Already have an account?';
        switchLink.textContent = 'Sign In';
    } else {
        modalTitle.textContent = 'Sign In';
        submitBtn.textContent = 'Sign In';
        switchText.textContent = "Don't have an account?";
        switchLink.textContent = 'Sign Up';
    }
}

function updateAuthUI() {
    const signInBtn = document.getElementById('signInBtn');
    const profileAvatar = document.getElementById('profileAvatar');
    
    if (currentUser) {
        const displayName = currentUser.displayName || 'User';
        const firstName = displayName.split(' ')[0];
        signInBtn.innerHTML = `${firstName}`;
        
        // Update avatar
        if (currentUser.photoURL) {
            profileAvatar.innerHTML = `<img src="${currentUser.photoURL}" alt="Profile">`;
        } else {
            // Use first letter of name or email
            const initial = displayName.charAt(0).toUpperCase() || currentUser.email.charAt(0).toUpperCase();
            profileAvatar.innerHTML = initial;
        }
    } else {
        signInBtn.innerHTML = 'Sign In';
        profileAvatar.innerHTML = 'W';
    }
    
    updateSellerButton();
    updateDetailPageAuth();
}

// ================================
// LOGIN/PROFILE MODAL FUNCTIONS
// ================================
function showLogin() {
    const modal = document.getElementById('loginModal');
    
    if (currentUser) {
        // User is signed in - show profile
        showUserProfile();
    } else {
        // User not signed in - show login form
        showLoginForm();
    }
}

function showLoginForm() {
    // Reset to sign-in mode
    isSignUpMode = false;
    updateAuthModalUI();
    
    // Show login elements, hide profile
    document.getElementById('googleSignInSection').style.display = 'block';
    document.getElementById('authFormSection').style.display = 'block';
    document.getElementById('userInfo').style.display = 'none';
    
    // Clear form
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    
    // Show modal
    document.getElementById('loginModal').style.display = 'block';
}

function showUserProfile() {
    if (currentUser) {
        // Check if user is a seller first
        db.collection('sellers').doc(currentUser.uid).get()
            .then((doc) => {
                // Hide login elements, show profile
                document.getElementById('googleSignInSection').style.display = 'none';
                document.getElementById('authFormSection').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('modalTitle').textContent = 'Profile';
                
                // Update user info
                document.getElementById('userName').textContent = currentUser.displayName || 'User';
                document.getElementById('userEmail').textContent = currentUser.email;
                
                if (currentUser.photoURL) {
                    document.getElementById('userPhoto').src = currentUser.photoURL;
                    document.getElementById('userPhoto').style.display = 'block';
                } else {
                    document.getElementById('userPhoto').style.display = 'none';
                }
                
                // Update userInfo section
                const userInfoDiv = document.getElementById('userInfo');
                const existingButtons = userInfoDiv.querySelector('.profile-buttons');
                if (existingButtons) existingButtons.remove();
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'profile-buttons';
                buttonsDiv.style.cssText = 'display: flex; flex-direction: column; gap: 0.8rem; margin-top: 1rem;';
                
                if (doc.exists) {
                    // User is a seller - only show seller dashboard
                    buttonsDiv.innerHTML = `
                        <button onclick="closeLogin(); showSellerDashboard();" class="btn" style="width: 100%;">Seller Dashboard</button>
                        <button onclick="signOut()" class="btn" style="width: 100%;">Sign Out</button>
                    `;
                } else {
                    // User is not a seller
                    buttonsDiv.innerHTML = `
                        <button onclick="closeLogin(); showSellerSignup();" class="btn" style="width: 100%; background: #007185;">Become a Seller</button>
                        <button onclick="signOut()" class="btn" style="width: 100%;">Sign Out</button>
                    `;
                }
                
                // Replace the sign out button
                const existingSignOut = userInfoDiv.querySelector('button');
                if (existingSignOut) {
                    existingSignOut.replaceWith(buttonsDiv);
                } else {
                    userInfoDiv.appendChild(buttonsDiv);
                }
                
                // Show modal
                document.getElementById('loginModal').style.display = 'block';
            })
            .catch((error) => {
                console.error('Error checking seller status:', error);
                showBasicProfile();
            });
    }
}

function showBasicProfile() {
    // Basic profile without seller check (fallback)
    document.getElementById('googleSignInSection').style.display = 'none';
    document.getElementById('authFormSection').style.display = 'none';
    document.getElementById('userInfo').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'Profile';
    
    document.getElementById('userName').textContent = currentUser.displayName || 'User';
    document.getElementById('userEmail').textContent = currentUser.email;
    
    if (currentUser.photoURL) {
        document.getElementById('userPhoto').src = currentUser.photoURL;
        document.getElementById('userPhoto').style.display = 'block';
    } else {
        document.getElementById('userPhoto').style.display = 'none';
    }
    
    document.getElementById('loginModal').style.display = 'block';
}

function closeLogin() {
    document.getElementById('loginModal').style.display = 'none';
}

// ================================
// FORGOT PASSWORD FUNCTIONS
// ================================
function showForgotPassword() {
    closeLogin();
    document.getElementById('forgotPasswordModal').style.display = 'block';
}

function closeForgotPassword() {
    document.getElementById('forgotPasswordModal').style.display = 'none';
    document.getElementById('forgotEmail').value = '';
}

function handleForgotPassword(event) {
    event.preventDefault();
    const email = document.getElementById('forgotEmail').value;
    
    auth.sendPasswordResetEmail(email)
        .then(() => {
            alert('Password reset email sent! Check your inbox.');
            closeForgotPassword();
        })
        .catch((error) => {
            console.error('Password reset error:', error);
            alert('Error sending reset email: ' + error.message);
        });
}

// ================================
// PRODUCT MANAGEMENT FUNCTIONS
// ================================
function loadProductsFromFirebase() {
    db.collection('products').onSnapshot((snapshot) => {
        products = [];
        snapshot.forEach((doc) => {
            products.push({
                id: doc.id,
                ...doc.data()
            });
        });
        displayProducts();
    });
}

function displayProducts() {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';

    products.forEach(product => {
        const productCard = createProductCard(product);
        grid.appendChild(productCard);
    });
}

function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    const reviews = product.reviews || [];
    const reviewCount = reviews.length;
    const avgRating = reviews.length > 0 
        ? reviews.reduce((sum, review) => sum + review.rating, 0) / reviews.length 
        : 0;
    
    const starsHTML = Array.from({length: 5}, (_, i) => {
        if (i < Math.floor(avgRating)) {
            return `<span class="star">★</span>`;
        } else {
            return `<span class="star empty">☆</span>`;
        }
    }).join('');
    
    // Truncate description - shorter for mobile
    const fullDescription = product.description || 'DESCRIPTION';
    const truncatedDescription = fullDescription.length > 60 
        ? fullDescription.substring(0, 60) + '...' 
        : fullDescription;
    
    // Don't truncate seller name - show full name
    const sellerInfo = product.sellerBusinessName 
        ? `SOLD BY: ${product.sellerBusinessName}`
        : '';
    
    // Calculate delivery with separate lines
    let deliveryHTML = '';
    if (product.knutsfordDelivery || product.taraDelivery) {
        let deliveryLines = [];
        
        if (product.knutsfordDelivery) {
            const knutsfordDates = calculateDeliveryDates(product.knutsfordDelivery);
            if (knutsfordDates) {
                deliveryLines.push(`KNUTSFORD: ${knutsfordDates.start} - ${knutsfordDates.end}`);
            }
        }
        
        if (product.taraDelivery) {
            const taraDates = calculateDeliveryDates(product.taraDelivery);
            if (taraDates) {
                deliveryLines.push(`TARA: ${taraDates.start} - ${taraDates.end}`);
            }
        }
        
        if (deliveryLines.length > 0) {
            deliveryHTML = deliveryLines.map(line => `<p class="delivery-line">${line}</p>`).join('');
        }
    }

    // Stock information
    const stock = product.stock !== undefined ? product.stock : null;
    const lowStockAlert = product.lowStockAlert || 5;
    let stockHTML = '';
    let stockStatus = '';
    
    if (stock === null) {
        // For products without stock tracking, show as available
        stockHTML = '<p class="stock-info in-stock" style="color: #28a745; font-size: 0.8rem; margin: 0.3rem 0;">In Stock</p>';
        stockStatus = 'in-stock';
    } else if (stock <= 0) {
        stockHTML = '<p class="stock-info out-of-stock" style="color: #ff4757; font-weight: bold; font-size: 0.8rem; margin: 0.3rem 0;">OUT OF STOCK</p>';
        stockStatus = 'out-of-stock';
    } else if (stock <= lowStockAlert) {
        stockHTML = `<p class="stock-info low-stock" style="color: #ff8c00; font-weight: bold; font-size: 0.8rem; margin: 0.3rem 0;">ONLY ${stock} LEFT!</p>`;
        stockStatus = 'low-stock';
    } else if (stock < 20) {
        stockHTML = `<p class="stock-info normal-stock" style="color: #28a745; font-size: 0.8rem; margin: 0.3rem 0;">${stock} available</p>`;
        stockStatus = 'normal-stock';
    } else {
        stockHTML = '<p class="stock-info in-stock" style="color: #28a745; font-size: 0.8rem; margin: 0.3rem 0;">In Stock</p>';
        stockStatus = 'in-stock';
    }
    
    // Button text and state based on stock
    let buttonHTML = '';
    if (stock === 0) {
        buttonHTML = '<button class="add-to-cart out-of-stock" disabled style="background: #ccc; cursor: not-allowed;">Out of Stock</button>';
    } else {
        buttonHTML = `<button class="add-to-cart ${stockStatus}" data-product-id="${product.id}">Add to cart</button>`;
    }
    
    card.innerHTML = `
        <div class="product-image">
            <img src="${product.image || 'https://via.placeholder.com/200x250?text=No+Image'}" alt="${product.name || 'Product'}" onerror="this.src='https://via.placeholder.com/200x250?text=No+Image'">
        </div>
        <div class="product-details">
            <div class="product-header">
                <h3 class="product-title">${product.name || 'Untitled Product'}</h3>
                <p class="product-description">${truncatedDescription}</p>
                <div class="stars">${starsHTML} <span class="review-count">(${reviewCount})</span></div>
                ${deliveryHTML ? `<div class="delivery-info">${deliveryHTML}</div>` : ''}
                ${sellerInfo ? `<p class="seller-info" style="margin-bottom: 1rem;">${sellerInfo}</p>` : ''}
                ${stockHTML}
                ${product.category === 'clothing' && product.sizes && product.sizes.length > 0 ? 
                `<p style="color: #666; font-size: 0.8rem; margin: 0.2rem 0 1rem 0;">Sizes: ${product.sizes.join(', ')}</p>` : ''}
                <div class="product-price" style="margin-bottom: 0.5rem;">$${product.price || '0.00'}</div>
                <div style="text-align: center; margin-bottom: 0;">
                    ${buttonHTML}
                </div>
            </div>
        </div>
    `;
    
    // Add opacity overlay for out of stock products
    if (stock === 0) {
        card.style.opacity = '0.7';
        card.style.position = 'relative';
    }
    
    // Add click event to the entire card first
    card.addEventListener('click', function(e) {
        // Check if click is NOT on add-to-cart button or its children
        if (!e.target.closest('.add-to-cart')) {
            showProductDetail(product);
        }
    });
    
    // Then add click event to the button with event stopping (only if not out of stock)
    const addToCartBtn = card.querySelector('.add-to-cart:not([disabled])');
    if (addToCartBtn) {
        addToCartBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            addToCart(product.id);
            return false;
        });
    }
    
    return card;
}

function searchProducts() {
    const searchInput = document.querySelector('.search-bar');
    const searchTerm = searchInput.value.toLowerCase();
    const filteredProducts = products.filter(product => 
        product.name.toLowerCase().includes(searchTerm) || 
        product.description.toLowerCase().includes(searchTerm) ||
        (product.sellerBusinessName && product.sellerBusinessName.toLowerCase().includes(searchTerm))
    );
    
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';
    
    filteredProducts.forEach(product => {
        const productCard = createProductCard(product);
        grid.appendChild(productCard);
    });
    
    if (filteredProducts.length === 0) {
        grid.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No products or stores found matching your search.</div>';
    }
}

function filterByCategory(category) {
    currentCategory = category;
    
    // Update active button
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#ffd700';
        btn.style.color = '#333';
    });
    
    event.target.classList.add('active');
    event.target.style.background = '#333';
    event.target.style.color = '#ffd700';
    
    // Filter products
    displayFilteredProducts(category);
}

function displayFilteredProducts(category) {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';

    let filteredProducts = products;
    if (category !== 'all') {
        filteredProducts = products.filter(product => 
            product.category && product.category.toLowerCase() === category.toLowerCase()
        );
    }

    filteredProducts.forEach(product => {
        const productCard = createProductCard(product);
        grid.appendChild(productCard);
    });
    
    if (filteredProducts.length === 0) {
        grid.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No products found in this category.</div>';
    }
}

// ================================
// PRODUCT DETAIL VIEW FUNCTIONS
// ================================
function showProductDetail(product) {
    let detailView = document.getElementById('productDetailView');
    if (!detailView) {
        detailView = document.createElement('div');
        detailView.id = 'productDetailView';
        detailView.className = 'product-detail-view';
        document.body.appendChild(detailView);
    }
    
    const reviews = product.reviews || [];
    const avgRating = reviews.length > 0 
        ? reviews.reduce((sum, review) => sum + review.rating, 0) / reviews.length 
        : 0;
    
    const starsHTML = Array.from({length: 5}, (_, i) => {
        const starClass = i < Math.floor(avgRating) ? 'star' : 'star empty';
        return `<span class="${starClass}">★</span>`;
    }).join('');
    
    detailView.innerHTML = `
        <!-- Header -->
        <div class="header-lime-bar"></div>
        <header class="header">
            <div class="header-top">
                <div class="header-content">
                    <!-- Profile Section - Left -->
                    <div class="profile-section" onclick="showLogin()">
                        <div class="profile-avatar" id="detailProfileAvatar">W</div>
                        <button class="btn profile-btn" id="detailSignInBtn">PROFILE</button>
                    </div>

                    <div class="logo">WEB VTEC</div>
                    
                    <!-- Sell Button - Right -->
                    <button class="sell-btn-clean" onclick="closeProductDetail()">
                        <div class="sell-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3zm0 2.8l6 6V20h-2v-6H8v6H6v-8.2l6-6z"/>
                            </svg>
                        </div>
                        <span id="sellerBtnText">SELL</span>
                    </button>
                </div>

                <div class="header-separator"></div>
            </div>

            <!-- Categories Section -->
            <div class="categories-section" style="padding: 0.2rem 5px; margin-bottom: 0.25rem;">
                <div class="categories-scroll" style="display: flex; gap: 0.8rem; overflow-x: auto; padding: 0.3rem 0; scrollbar-width: none; -ms-overflow-style: none;">
                    <button class="category-btn active" onclick="filterByCategory('all')" style="background: #333; color: #ffd700; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">All</button>
                    <button class="category-btn" onclick="filterByCategory('jewelry')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 80px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Jewelry</button>
                    <button class="category-btn" onclick="filterByCategory('health')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Health</button>
                    <button class="category-btn" onclick="filterByCategory('music')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Music</button>
                </div>
            </div>

            <!-- Search Container - Center -->
            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Search products..." onkeyup="searchProducts()">
                <button class="search-btn" onclick="searchProducts()">🔍</button>
            </div>
        </header>

        <div style="padding: 20px; margin-top: 10px;">
            <h2 style="text-align: left; color: #333; margin: 0.5rem 0; font-size: 1.5rem; font-weight: bold; text-transform: uppercase;">${product.name}</h2>
            
            <div class="stars" style="justify-content: flex-start; margin-bottom: 1rem;">
                ${starsHTML} <span style="color: #666; margin-left: 10px;">(${reviews.length})</span>
            </div>
            
            <div class="product-gallery">
                <div class="photo-gallery">
                    <div class="photo-container" id="photoContainer-${product.id}">
                        ${(product.images || [product.image]).filter(img => img).map(img => 
                            `<div class="photo-slide"><img src="${img}" alt="${product.name}"></div>`
                        ).join('')}
                    </div>
                    ${(product.images || []).length > 1 ? `
                        <div class="photo-nav">
                            ${(product.images || [product.image]).filter(img => img).map((_, i) => 
                                `<div class="photo-dot ${i === 0 ? 'active' : ''}" onclick="goToPhoto('${product.id}', ${i})"></div>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                <div class="detail-price" style="margin: 0;">${product.price}</div>
            </div>
            
            <div class="detail-actions">
                <button class="detail-add-to-cart" onclick="addToCart('${product.id}'); closeProductDetail();">Add to Cart</button>
            </div>
            
            <div style="margin-top: 2rem;">
                <h3 style="color: #333;">Product Details</h3>
                <p style="color: #666;">${product.description || 'Detailed product information goes here.'}</p>
            </div>
            
            <div style="margin-top: 2rem;">
                <h3 style="color: #333;">Customer Reviews</h3>
                <div class="reviews-list">
                    ${reviews.map(review => `
                        <div class="review-item" style="background: #f9f9f9; color: #333;">
                            <div class="review-header">
                                <span class="reviewer-name" style="color: #333;">${review.name}</span>
                                <span class="review-stars" style="color: #ffa500;">${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</span>
                            </div>
                            <p>${review.comment}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    detailView.classList.add('active');
    setTimeout(() => {
        if (typeof initializePhotoGallery === 'function') {
            initializePhotoGallery(product.id);
        }
        if (typeof updateDetailPageAuth === 'function') {
            updateDetailPageAuth();
        }
    }, 200);
}

function closeProductDetail() {
    const detailView = document.getElementById('productDetailView');
    if (detailView) {
        detailView.classList.remove('active');
    }
}

function updateDetailPageAuth() {
    const detailSignInBtn = document.getElementById('detailSignInBtn');
    const detailProfileAvatar = document.getElementById('detailProfileAvatar');
    
    if (detailSignInBtn && detailProfileAvatar) {
        if (currentUser) {
            const displayName = currentUser.displayName || 'User';
            const firstName = displayName.split(' ')[0];
            detailSignInBtn.innerHTML = `${firstName}`;
            
            // Update avatar
            if (currentUser.photoURL) {
                detailProfileAvatar.innerHTML = `<img src="${currentUser.photoURL}" alt="Profile">`;
            } else {
                const initial = displayName.charAt(0).toUpperCase() || currentUser.email.charAt(0).toUpperCase();
                detailProfileAvatar.innerHTML = initial;
            }
        } else {
            detailSignInBtn.innerHTML = 'Sign In';
            detailProfileAvatar.innerHTML = 'W';
        }
    }
}

function shareProduct(productId, productName) {
    const productUrl = `${window.location.origin}${window.location.pathname}?product=${productId}`;
    const shareText = `Check out ${productName} on WEBVTEC!`;
    
    if (navigator.share) {
        // Use native share API (mobile devices)
        navigator.share({
            title: productName,
            text: shareText,
            url: productUrl
        });
    } else {
        // Fallback: copy link to clipboard
        navigator.clipboard.writeText(productUrl).then(() => {
            alert('Product link copied to clipboard!');
        }).catch(() => {
            // If clipboard fails, show the link
            prompt('Copy this link to share:', productUrl);
        });
    }
}

// ================================
// CART MANAGEMENT FUNCTIONS
// ================================
function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return false;
    
    // Check stock availability - only if stock tracking is enabled
    if (product.stock !== undefined && product.stock <= 0) {
        alert('This product is out of stock');
        return false;
    }
    
    const existingItem = cart.find(item => item.id === productId);
    const currentQuantity = existingItem ? existingItem.quantity : 0;
    
    // Only check stock limits if stock tracking is enabled
    if (product.stock !== undefined && currentQuantity >= product.stock) {
        alert(`Only ${product.stock} items available in stock`);
        return false;
    }
    
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({ 
            ...product, 
            quantity: 1,
            sellerId: product.sellerId,
            sellerBusinessName: product.sellerBusinessName || 'Unknown Seller'
        });
    }
    
    updateCartCount();
    showCartNotification(product.name);
    return false;
}

function updateCartCount() {
    const count = cart.reduce((total, item) => total + item.quantity, 0);
    const cartBadge = document.getElementById('cartCountFloat');
    if (cartBadge) {
        cartBadge.textContent = count;
        cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
}

function showCartNotification(productName) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(45deg, #ffd700, #ffed4a);
        color: #333;
        padding: 1rem;
        border-radius: 10px;
        z-index: 3000;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    `;
    notification.textContent = `${productName} added to cart!`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function showCart() {
    if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
    }
    
    const groupedCart = groupCartBySeller();
    let cartHTML = '<h3 style="color: #ffd700; margin-bottom: 1.5rem;">Your Cart</h3>';
    let grandTotal = 0;
    
    Object.entries(groupedCart).forEach(([sellerId, sellerGroup]) => {
        cartHTML += `
            <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #ffd700;">
                <h4 style="color: #ffd700; margin-bottom: 0.5rem;">From: ${sellerGroup.sellerName}</h4>
        `;
        
        sellerGroup.items.forEach(item => {
            const itemTotal = item.price * item.quantity;
            cartHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <span style="font-weight: bold;">${item.name}</span>
                        <span style="color: #ccc; margin-left: 10px;">x${item.quantity}</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span>JMD ${itemTotal.toFixed(2)}</span>
                        <button onclick="removeFromCart('${item.id}')" style="background: #ff4757; color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Remove</button>
                    </div>
                </div>
            `;
        });
        
        cartHTML += `
                <div style="text-align: right; margin-top: 0.5rem;">
                    <strong style="color: #ffd700;">Subtotal: JMD ${sellerGroup.subtotal.toFixed(2)}</strong>
                </div>
            </div>
        `;
        
        grandTotal += sellerGroup.subtotal;
    });
    
    cartHTML += `
        <div style="background: rgba(255, 215, 0, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;">
            <h3 style="color: #ffd700; margin: 0;">Total: JMD ${grandTotal.toFixed(2)}</h3>
            <p style="color: #ccc; font-size: 0.8rem; margin: 0.5rem 0 0 0;">
                Items from ${Object.keys(groupedCart).length} seller(s)
            </p>
        </div>
        <button onclick="proceedToCheckout()" class="btn" style="width: 100%; margin-top: 1rem;">Proceed to Checkout</button>
    `;
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            ${cartHTML}
        </div>
    `;
    document.body.appendChild(modal);
}

function removeFromCart(productId) {
    const index = cart.findIndex(item => item.id === productId);
    if (index !== -1) {
        cart.splice(index, 1);
        updateCartCount();
        
        // Refresh cart display
        const modal = document.querySelector('.modal');
        if (modal) {
            modal.remove();
            showCart();
        }
    }
}

function groupCartBySeller() {
    const grouped = {};
    
    cart.forEach(item => {
        const sellerId = item.sellerId;
        const sellerName = item.sellerBusinessName || 'Unknown Seller';
        
        if (!grouped[sellerId]) {
            grouped[sellerId] = {
                sellerName: sellerName,
                items: [],
                subtotal: 0
            };
        }
        
        grouped[sellerId].items.push(item);
        grouped[sellerId].subtotal += item.price * item.quantity;
    });
    
    return grouped;
}

// ================================
// CHECKOUT & ORDER FUNCTIONS
// ================================
function proceedToCheckout() {
    if (!currentUser) {
        alert('Please sign in to proceed with checkout');
        return;
    }
    
    if (cart.length === 0) {
        alert('Your cart is empty');
        return;
    }
    
    // Show shipping form
    showShippingForm();
}

function showShippingForm() {
    const groupedCart = groupCartBySeller();
    const totalAmount = Object.values(groupedCart).reduce((sum, group) => sum + group.subtotal, 0);
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h2 style="color: #ffd700; margin-bottom: 1rem;">Delivery Information</h2>
            
            <!-- Delivery Location Selection -->
            <div class="form-group">
                <label>Select Delivery Location:</label>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <button type="button" id="knutsfordBtn" onclick="selectDeliveryLocation('knutsford')" style="flex: 1; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; background: white; color: #333; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                        KNUTSFORD
                    </button>
                    <button type="button" id="taraBtn" onclick="selectDeliveryLocation('tara')" style="flex: 1; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; background: white; color: #333; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                        TARA
                    </button>
                </div>
                <p style="color: #ccc; font-size: 0.8rem; margin: 0.5rem 0 0 0;">Please select your preferred delivery location first</p>
            </div>

            <!-- Dynamic Form Container -->
            <div id="dynamicFormContainer" style="display: none;">
                <form id="shippingForm" onsubmit="completeOrder(event)">
                    <input type="hidden" id="deliveryLocation" required>
                    
                    <!-- Form fields will be inserted here dynamically -->
                    <div id="formFields"></div>
                    
                    <div style="background: rgba(255, 215, 0, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h3 style="color: #ffd700; margin: 0 0 0.5rem 0;">Order Summary</h3>
                        <p style="color: #ccc; margin: 0;">Items from ${Object.keys(groupedCart).length} seller(s)</p>
                        <h4 style="color: #ffd700; margin: 0.5rem 0 0 0;">Total: JMD ${totalAmount.toFixed(2)}</h4>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">Complete Order</button>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function selectDeliveryLocation(location) {
    // Update hidden input
    document.getElementById('deliveryLocation').value = location;
    
    // Reset button styles
    document.getElementById('knutsfordBtn').style.borderColor = '#ddd';
    document.getElementById('knutsfordBtn').style.background = 'white';
    document.getElementById('knutsfordBtn').style.color = '#333';
    
    document.getElementById('taraBtn').style.borderColor = '#ddd';
    document.getElementById('taraBtn').style.background = 'white';
    document.getElementById('taraBtn').style.color = '#333';
    
    // Highlight selected button
    const selectedBtn = document.getElementById(location + 'Btn');
    selectedBtn.style.borderColor = '#007185';
    selectedBtn.style.background = '#007185';
    selectedBtn.style.color = 'white';
    
    // Show form container and populate form fields
    document.getElementById('dynamicFormContainer').style.display = 'block';
    populateFormFields(location);
}

function populateFormFields(location) {
    const formContainer = document.getElementById('formFields');
    
    if (location === 'knutsford') {
        formContainer.innerHTML = `
            <div class="form-group">
                <label>Full Name:</label>
                <input type="text" id="shippingName" required>
            </div>
            <div class="form-group">
                <label>Phone Number:</label>
                <input type="tel" id="shippingPhone" required placeholder="e.g., 876-555-1234">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="shippingEmail" value="${currentUser?.email || ''}" required>
            </div>
            <div class="form-group">
                <label>Select Knutsford Pickup Location:</label>
                <select id="knutsfordPickupLocation" required style="width: 100%; padding: 0.7rem; border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 215, 0, 0.3);">
                    <option value="">Choose your pickup location</option>
                    <option value="10 Harbour Circle, Montego Bay">10 Harbour Circle, Montego Bay (Knutsford)</option>
                    <option value="18 Dominica Drive, New Kingston">18 Dominica Drive, New Kingston (Knutsford)</option>
                    <option value="Lot 12, Drax Hall, St. Ann">Lot 12, Drax Hall, St. Ann (Knutsford)</option>
                    <option value="1222 Providence Drive, Montego Bay">1222 Providence Drive, Montego Bay (Knutsford)</option>
                    <option value="1310 Providence Drive, Ironshore, Montego Bay">1310 Providence Drive, Ironshore, Montego Bay (Knutsford)</option>
                    <option value="Negril, Westmoreland">Negril, Westmoreland (Knutsford)</option>
                    <option value="Lucea, Hanover">Lucea, Hanover (Knutsford)</option>
                    <option value="Montego Bay Airport, St. James">Montego Bay Airport, St. James (Knutsford)</option>
                    <option value="Falmouth, Trelawny">Falmouth, Trelawny (Knutsford)</option>
                    <option value="Angels (Spanish Town), St. Catherine">Angels (Spanish Town), St. Catherine (Knutsford)</option>
                    <option value="New Kingston, Kingston">New Kingston, Kingston (Knutsford)</option>
                    <option value="Gutters, St. Elizabeth">Gutters, St. Elizabeth (Knutsford)</option>
                    <option value="Luana, St. Elizabeth">Luana, St. Elizabeth (Knutsford)</option>
                    <option value="Mandeville, Manchester">Mandeville, Manchester (Knutsford)</option>
                    <option value="Savanna-la-mar, Westmoreland">Savanna-la-mar, Westmoreland (Knutsford)</option>
                    <option value="May Pen, Clarendon">May Pen, Clarendon (Knutsford)</option>
                    <option value="Port Antonio, Portland">Port Antonio, Portland (Knutsford)</option>
                    <option value="Port Maria, St. Mary">Port Maria, St. Mary (Knutsford)</option>
                    <option value="Annotto Bay, St. Mary">Annotto Bay, St. Mary (Knutsford)</option>
                    <option value="Montego Bay (Pier 1), St. James">Montego Bay (Pier 1), St. James (Knutsford)</option>
                    <option value="Ocho Rios, St. Ann">Ocho Rios, St. Ann (Knutsford)</option>
                    <option value="Washington Boulevard, Kingston">Washington Boulevard, Kingston (Knutsford)</option>
                    <option value="Harbour View, St. Andrew">Harbour View, St. Andrew (Knutsford)</option>
                    <option value="Portmore, St. Catherine">Portmore, St. Catherine (Knutsford)</option>
                </select>
                <p style="color: #ccc; font-size: 0.8rem; margin: 0.5rem 0 0 0;">Your order will be ready for pickup at the selected Knutsford location</p>
            </div>
        `;
    } else if (location === 'tara') {
        formContainer.innerHTML = `
            <div class="form-group">
                <label>Full Name:</label>
                <input type="text" id="shippingName" required>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="shippingEmail" value="${currentUser?.email || ''}" required>
            </div>
            <div class="form-group">
                <label>Phone Number:</label>
                <input type="tel" id="shippingPhone" required placeholder="e.g., 876-555-1234">
            </div>
            <div class="form-group">
                <label>Delivery Address:</label>
                <input type="text" id="shippingAddress" required placeholder="Enter your full delivery address">
            </div>
            <div class="form-group">
                <label>Parish:</label>
                <select id="shippingParish" required>
                    <option value="">Select Parish</option>
                    <option value="Kingston">Kingston</option>
                    <option value="St. Andrew">St. Andrew</option>
                    <option value="St. Thomas">St. Thomas</option>
                    <option value="Portland">Portland</option>
                    <option value="St. Mary">St. Mary</option>
                    <option value="St. Ann">St. Ann</option>
                    <option value="Trelawny">Trelawny</option>
                    <option value="St. James">St. James</option>
                    <option value="Hanover">Hanover</option>
                    <option value="Westmoreland">Westmoreland</option>
                    <option value="St. Elizabeth">St. Elizabeth</option>
                    <option value="Manchester">Manchester</option>
                    <option value="Clarendon">Clarendon</option>
                    <option value="St. Catherine">St. Catherine</option>
                </select>
            </div>
        `;
    }
}

async function completeOrder(event) {
    event.preventDefault();
    
    const deliveryLocation = document.getElementById('deliveryLocation').value;
    if (!deliveryLocation) {
        alert('Please select a delivery location');
        return;
    }
    
    const groupedCart = groupCartBySeller();
    const totalAmount = Object.values(groupedCart).reduce((sum, group) => sum + group.subtotal, 0);
    const mainOrderId = generateMainOrderId();
    
    // Collect shipping information
    let shippingAddress;
    if (deliveryLocation === 'knutsford') {
        const pickupLocation = document.getElementById('knutsfordPickupLocation').value;
        if (!pickupLocation) {
            alert('Please select a Knutsford pickup location');
            return;
        }
        
        shippingAddress = {
            name: document.getElementById('shippingName').value,
            email: document.getElementById('shippingEmail').value,
            phone: document.getElementById('shippingPhone').value,
            pickupLocation: pickupLocation,
            deliveryLocation: deliveryLocation.toUpperCase(),
            deliveryType: 'pickup'
        };
    } else {
        shippingAddress = {
            name: document.getElementById('shippingName').value,
            email: document.getElementById('shippingEmail').value,
            phone: document.getElementById('shippingPhone').value,
            address: document.getElementById('shippingAddress').value,
            parish: document.getElementById('shippingParish').value,
            deliveryLocation: deliveryLocation.toUpperCase(),
            deliveryType: 'home_delivery'
        };
    }
    
    // Create order data
    const orderData = {
        orderId: mainOrderId,
        buyerId: currentUser.uid,
        buyerEmail: currentUser.email,
        totalAmount: totalAmount,
        currency: 'JMD',
        status: 'pending_payment',
        createdAt: new Date().toISOString(),
        shippingAddress: shippingAddress,
        sellers: {}
    };
    
    // Process each seller's items
    Object.entries(groupedCart).forEach(([sellerId, sellerGroup]) => {
        const orderNumber = generateOrderNumber(sellerId);
        
        orderData.sellers[sellerId] = {
            orderNumber: orderNumber,
            sellerName: sellerGroup.sellerName,
            items: sellerGroup.items.map(item => ({
                productId: item.id,
                productName: item.name,
                price: item.price,
                quantity: item.quantity,
                subtotal: item.price * item.quantity
            })),
            subtotal: sellerGroup.subtotal,
            status: 'pending_payment',
            deliveryLocation: deliveryLocation.toUpperCase(),
            deliveryType: shippingAddress.deliveryType
        };
    });
    
    // Show payment modal
    showPaymentModal(orderData);
}

// Generate unique order numbers for each seller
function generateOrderNumber(sellerId) {
    const timestamp = Date.now().toString().slice(-8);
    const sellerCode = sellerId.slice(0, 4).toUpperCase();
    return `WV${sellerCode}${timestamp}`;
}

function generateMainOrderId() {
    return `WVO${Date.now()}${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
}

async function saveOrderToFirestore(orderData) {
    try {
        // Save main order
        await db.collection('orders').doc(orderData.orderId).set(orderData);
        
        // Save individual seller orders for easier querying
        for (const [sellerId, sellerData] of Object.entries(orderData.sellers)) {
            await db.collection('sellerOrders').doc(sellerData.orderNumber).set({
                orderNumber: sellerData.orderNumber,
                mainOrderId: orderData.orderId,
                sellerId: sellerId,
                sellerName: sellerData.sellerName,
                buyerId: orderData.buyerId,
                buyerEmail: orderData.buyerEmail,
                items: sellerData.items,
                subtotal: sellerData.subtotal,
                status: sellerData.status,
                createdAt: orderData.createdAt,
                shippingAddress: orderData.shippingAddress
            });
        }
        
        return true;
    } catch (error) {
        console.error('Error saving order:', error);
        return false;
    }
